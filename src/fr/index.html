---
title: Accueillir bébé
---

<main>
	<header></header>
	<nav><a href="./menu/">Menu</a></nav>
	<section id="content">
		<progress>Chargement...</progress>
	</section>
	<section id="loading">
		<progress>Chargement...</progress>
	</section>
	<section id="error">
		<img src="/assets/00112-1886873004.png" alt="" width="256" height="256" />
		<h1>Erreur</h1>
		<p>Cette page n'a pas pu être chargée...</p>
	</section>
	<footer>
		<button id="previous" class="action secondary" disabled>Précédent</button>
		<button id="next" class="action primary" disabled>Suivant</button>
		<button id="retry" class="action primary" disabled>Réessayer</button>
	</footer>
</main>

<script>
	var dateOfBirthInput = getSearchParam("date-of-birth") || getCookie("date-of-birth")
	var dateOfBirth = Boolean(dateOfBirthInput) && (parseFrenchDate(dateOfBirthInput) || parseDate(dateOfBirthInput))

	if (!dateOfBirth) {
		window.location.assign('./estimation-date-naissance/')
	}

	var daysLeftUntilBirth = computeDaysBetween(dateOfBirth, new Date())
	displayCurrentWeekNumber(daysLeftUntilBirth)

	var showContent = setDisplay('content', true)
	var hideContent = setDisplay('content', false)
	var showLoadingSpinner = setDisplay('loading', true)
	var hideLoadingSpinner = setDisplay('loading', false)
	var showErrorMessage = setDisplay('error', true)
	var hideErrorMessage = setDisplay('error', false)

	var articles = []
	var currentArticleIndex = -1

	function tryLoadArticleList() {
		hideContent()
		hideErrorMessage()
		showLoadingSpinner()
		disableRetryButton()

		loadArticleList(
			function success(json) {
				articles = json.articles
				var latestArticle = findLatestArticle()

				function tryLoadArticle() {
					hideContent()
					hideErrorMessage()
					showLoadingSpinner()
					disableRetryButton()

					loadArticle(
						latestArticle,
						function success(html) {
							currentArticleIndex = latestArticle.index

							displayArticle(html)
							hideLoadingSpinner()
							showContent()
							enableFooterButtons()
						},
						createErrorHandler(tryLoadArticle)
					)
				}

				tryLoadArticle()
			},
			createErrorHandler(tryLoadArticleList))
	}

	tryLoadArticleList()

	function parseFrenchDate(date) {
		var parsed = new Date(Date.parse(date.split("/").reverse().join("-")))
		return validateDate(parsed)
	}

	function parseDate(date) {
		var parsed = new Date(date)
		return validateDate(parsed)
	}

	function validateDate(date) {
		if (isNaN(date.getTime())) return undefined
		return date
	}

	function computeDaysBetween(latestDate, earliestDate) {
		var millisecondsBetweenDates = latestDate.getTime() - earliestDate.getTime()
		var millisecondsInDay = 1000 * 60 * 60 * 24
		return Math.floor(millisecondsBetweenDates / millisecondsInDay)
	}

	function loadArticleList(successCallback, errorCallback) {
		return load("articles.json", "json", successCallback, errorCallback)
	}


	function createErrorHandler(retryCallback) {
		return function (reason) {
			console.warn(reason)

			hideContent()
			hideLoadingSpinner()
			showErrorMessage()

			var previousButton = document.getElementById('previous')
			previousButton.disabled = true

			var nextButton = document.getElementById('next')
			nextButton.disabled = true

			var retryButton = document.getElementById('retry')
			var retryButtonClone = retryButton.cloneNode(true)
			retryButtonClone.addEventListener('click', retryCallback)
			retryButtonClone.disabled = false
			retryButton.parentNode.replaceChild(retryButtonClone, retryButton)
		}
	}

	function findLatestArticle() {
		var latestArticle = { url: undefined, daysLeft: Number.POSITIVE_INFINITY, index: -1 }
		for (var i = 0; i < articles.length && daysLeftUntilBirth <= articles[i].daysLeft; ++i) {
			if (articles[i].daysLeft <= latestArticle.daysLeft) {
				latestArticle = articles[i]
			}
		}
		if (latestArticle.url) {
			return latestArticle
		}
		return undefined
	}

	function loadArticle(article, successCallback, errorCallback) {
		return load(article.url, "text", successCallback, errorCallback)
	}

	function load(url, responseType, successCallback, errorCallback) {
		var request = new XMLHttpRequest()
		request.addEventListener("load", requestListener)
		request.addEventListener("error", errorCallback)
		request.addEventListener("timeout", errorCallback)
		request.timeout = 1000
		request.responseType = responseType
		request.open("GET", url, true)
		request.send()

		function requestListener() {
			if (request.readyState === 4) {
				if (request.status === 200) {
					successCallback(request.response)
				} else {
					errorCallback(request.statusText)
				}
			}
		}
	}

	function displayArticle(html) {
		var contentSection = document.getElementById('content')
		var startPos = html.indexOf('<article')
		var endPos = html.indexOf('</article>')
		if (startPos > -1 && endPos > -1) {
			var content = html.substring(startPos, endPos + '</article>'.length)
			contentSection.innerHTML = content
		}
	}

	function displayCurrentWeekNumber(daysLeft) {
		var weeksLeft = Math.floor(daysLeft / 7)
		var currentWeekNumber = 40 - weeksLeft

		var label = "Au départ"
		if (currentWeekNumber > 1) {
			label = currentWeekNumber + ' semaines'
		} else if (currentWeekNumber > 0) {
			label = currentWeekNumber + ' semaine'
		}

		var header = document.getElementsByTagName('header')[0]
		header.innerHTML = '<h2>' + label + '</h2>'
	}

	function setDisplay(elementId, isDisplayed) {
		return function () {
			var element = document.getElementById(elementId)
			element.style.display = isDisplayed ? 'block' : 'none'
		}
	}

	function enableFooterButtons() {
		var previousButton = document.getElementById('previous')
		previousButton.disabled = currentArticleIndex < 1

		var nextButton = document.getElementById('next')
		nextButton.disabled = currentArticleIndex >= articles.length - 1
	}

	function disableRetryButton() {
		var retryButton = document.getElementById('retry')
		retryButton.disabled = true
	}

	var handlePreviousButton = createHandler(function (i) { return i - 1 })
	document.getElementById('previous').addEventListener('click', handlePreviousButton)

	var handleNextButton = createHandler(function (i) { return i + 1 })
	document.getElementById('next').addEventListener('click', handleNextButton)

	function createHandler(updateIndex) {
		return function () {
			var newIndex = updateIndex(currentArticleIndex)
			var newArticle = articles[newIndex]

			hideContent()
			hideErrorMessage()
			showLoadingSpinner()
			disableRetryButton()

			loadArticle(
				newArticle,
				function success(html) {
					currentArticleIndex = newArticle.index
					displayArticle(html)
					hideLoadingSpinner()
					showContent()
					enableFooterButtons()
				},
				createErrorHandler(retryCallback)
			)

			function retryCallback() {
				hideErrorMessage()
				showContent()
				enableFooterButtons()
				disableRetryButton()
			}
		}
	}

	var handleResetLink = createHandler(function () { return findLatestArticle().index })
	document.getElementsByTagName('header')[0].addEventListener('click', handleResetLink)
</script>
